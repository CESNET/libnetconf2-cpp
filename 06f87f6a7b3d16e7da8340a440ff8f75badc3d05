{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "e4a084ed_1c14eb0e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2022-03-30T15:22:09Z",
      "side": 1,
      "message": "I\u0027m deliberately testing this as-is, without cherry-picking change 5634 on top of this one. This means that it is expected that this version (PS2) will fail for me locally because libyang happens to find some YANG models, and because libnetconf2 will therefore try to parse \"wrong\" responses (resposnes for command which were not send yet).\n\nThe code currently locks up *when running outside of gdb*. Simply running via `ctest` or even launching the binary on its own is enough to trigger this. The last output that is printed is:\n\n \nSession 1 [DBG]: Sending message:\n\u003crpc xmlns\u003d\"urn:ietf:params:xml:ns:netconf:base:1.0\" message-id\u003d\"1\"\u003e\u003cget-schema xmlns\u003d\"urn:ietf:params:xml:ns:yang:ietf-netconf-monitoring\"\u003e\u003cidentifier\u003eietf-yang-metadata\u003c/identifier\u003e\u003cversion\u003e2016-08-05\u003c/version\u003e\u003cformat xmlns:ncm\u003d\"urn:ietf:params:xml:ns:yang:ietf-netconf-monitoring\"\u003encm:yang\u003c/format\u003e\u003c/get-schema\u003e\u003c/rpc\u003e\n \nSession 1 [DBG]: Sending message:\n \n##\n \n \n\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n/home/jkt/work/cesnet/gerrit/CzechLight/libnetconf2-cpp/tests/client.cpp:29:\nTEST CASE:  client\n \nDEEPEST SUBCASE STACK REACHED (DIFFERENT FROM THE CURRENT ONE):\n  get-data\n  some data\n \n/home/jkt/work/cesnet/gerrit/CzechLight/libnetconf2-cpp/tests/mock_server.cpp:746: FATAL ERROR: REQUIRE( view.find(str) !\u003d std::string_view::npos ) is NOT correct!\n  values: REQUIRE( 18446744073709551615 !\u003d 18446744073709551615 )\n  logged: str :\u003d \u003crpc xmlns\u003d\"urn:ietf:params:xml:ns:netconf:base:1.0\" message-id\u003d\"1\"\u003e\u003cget-schema xmlns\u003d\"urn:ietf:params:xml:ns:yang:ietf-netconf-monitoring\"\u003e\u003cidentifier\u003eietf-netconf\u003c/identifier\u003e\u003cformat xmlns:ncm\u003d\"urn:ietf:params:xml:ns:yang:ietf-netconf-monitoring\"\u003encm:yang\u003c/format\u003e\u003c/get-schema\u003e\u003c/rpc\u003e\n          view :\u003d \n\u003crpc xmlns\u003d\"urn:ietf:params:xml:ns:netconf:base:1.0\" message-id\u003d\"1\"\u003e\u003cget-schema xmlns\u003d\"urn:ietf:params:xml:ns:yang:ietf-netconf-monitoring\"\u003e\u003cidentifier\u003eietf-yang-metadata\u003c/identifier\u003e\u003cversion\u003e2016-08-05\u003c/version\u003e\u003cformat xmlns:ncm\u003d\"urn:ietf:params:xml:ns:yang:ietf-netconf-monitoring\"\u003encm:yang\u003c/format\u003e\u003c/get-schema\u003e\u003c/rpc\u003e\n\nAnd here\u0027s the stack trace (obtained by attaching to a \"stuck\" test):\n \n(gdb) t a a bt\nThread 2 (Thread 0x7f38b09ff640 (LWP 3724362) \"test_client\"):\n#0  __libc_read (nbytes\u003d1, buf\u003d0x61600002b881, fd\u003d5) at ../sysdeps/unix/sysv/linux/read.c:26\n#1  __libc_read (fd\u003d5, buf\u003d0x61600002b881, nbytes\u003d1) at ../sysdeps/unix/sysv/linux/read.c:24\n#2  0x00000000004693bd in __interceptor_read.part.0 ()\n#3  0x00007f38b31f2dc4 in nc_read (session\u003d0x61300000ffc0, buf\u003d\u003coptimized out\u003e, count\u003d\u003coptimized out\u003e, inact_timeout\u003d20000, ts_act_timeout\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/io.c:120\n#4  0x00007f38b31ed4ca in nc_read_until (session\u003d0x61300000ffc0, endtag\u003d0x7f38b327a380 \u003cstr\u003e \"\\n#\", limit\u003d0, inact_timeout\u003d20000, ts_act_timeout\u003dts_act_timeout@entry\u003d0x7f38b09fd4a0, result\u003dresult@entry\u003d0x0) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/io.c:312\n#5  0x00007f38b31ecbe7 in nc_read_msg_io (session\u003d\u003coptimized out\u003e, io_timeout\u003d\u003coptimized out\u003e, msg\u003d\u003coptimized out\u003e, passing_io_lock\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/io.c:392\n#6  0x00007f38b31ee0b3 in nc_read_msg_poll_io (session\u003d\u003coptimized out\u003e, io_timeout\u003d\u003coptimized out\u003e, msg\u003d0x7f38b09fd810) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/io.c:599\n#7  0x00007f38b322e5e8 in recv_msg (session\u003d\u003coptimized out\u003e, timeout\u003d178305, expected\u003d\u003coptimized out\u003e, message\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/session_client.c:1939\n#8  0x00007f38b32207f3 in recv_reply (session\u003d\u003coptimized out\u003e, timeout\u003d\u003coptimized out\u003e, op\u003d\u003coptimized out\u003e, msgid\u003d\u003coptimized out\u003e, envp\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/session_client.c:1997\n#9  0x00007f38b321f8f3 in nc_recv_reply (session\u003d\u003coptimized out\u003e, rpc\u003drpc@entry\u003d0x604000008350, msgid\u003d1, timeout\u003dtimeout@entry\u003d300000, envp\u003denvp@entry\u003d0x7f38b09fdaa0, op\u003d\u003coptimized out\u003e, op@entry\u003d0x7f38b09fdac0) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/session_client.c:2211\n#10 0x00007f38b322d16a in retrieve_schema_data_getschema (name\u003d\u003coptimized out\u003e, rev\u003d\u003coptimized out\u003e, clb_data\u003d\u003coptimized out\u003e, format\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/session_client.c:410\n#11 0x00007f38b322be16 in retrieve_schema_data_imp (mod_name\u003d\u003coptimized out\u003e, mod_rev\u003d\u003coptimized out\u003e, submod_name\u003d\u003coptimized out\u003e, sub_rev\u003d0x0, user_data\u003d\u003coptimized out\u003e, format\u003d\u003coptimized out\u003e, module_data\u003d\u003coptimized out\u003e, free_module_data\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/session_client.c:602\n#12 0x00007f38b2b85928 in lys_parse_load_from_clb_or_file (ctx\u003d0x613000010180, name\u003d0x603000001870 \"ietf-yang-metadata\", revision\u003d0x0, mod_latest\u003d0x0, new_mods\u003d0x613000010200, mod\u003d0x61200002e148) at /home/jkt/work/cesnet/gerrit/github/CESNET/libyang/src/tree_schema_helpers.c:842\n#13 lys_parse_load (ctx\u003d\u003coptimized out\u003e, name\u003d\u003coptimized out\u003e, revision\u003d\u003coptimized out\u003e, new_mods\u003d\u003coptimized out\u003e, mod\u003d0x61200002e148) at /home/jkt/work/cesnet/gerrit/github/CESNET/libyang/src/tree_schema_helpers.c:967\n#14 0x00007f38b2b4caac in lys_resolve_import_include (pctx\u003d0x6070000096a0, pmod\u003d\u003coptimized out\u003e, new_mods\u003dnew_mods@entry\u003d0x613000010200) at /home/jkt/work/cesnet/gerrit/github/CESNET/libyang/src/tree_schema.c:1237\n#15 0x00007f38b2b4f7c0 in lys_parse_in (ctx\u003d\u003coptimized out\u003e, in\u003d\u003coptimized out\u003e, format\u003d\u003coptimized out\u003e, custom_check\u003d\u003coptimized out\u003e, check_data\u003d\u003coptimized out\u003e, new_mods\u003d\u003coptimized out\u003e, module\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libyang/src/tree_schema.c:1705\n#16 0x00007f38b2b590b1 in lys_parse (ctx\u003d\u003coptimized out\u003e, in\u003d\u003coptimized out\u003e, format\u003d\u003coptimized out\u003e, features\u003d\u003coptimized out\u003e, module\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libyang/src/tree_schema.c:1790\n#17 0x00007f38b321830e in nc_ctx_load_module (session\u003d\u003coptimized out\u003e, name\u003d\u003coptimized out\u003e, revision\u003d\u003coptimized out\u003e, features\u003d\u003coptimized out\u003e, schemas\u003d\u003coptimized out\u003e, user_clb\u003d\u003coptimized out\u003e, user_data\u003d\u003coptimized out\u003e, has_get_schema\u003d\u003coptimized out\u003e, mod\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/session_client.c:699\n#18 0x00007f38b32140c7 in nc_ctx_fill_ietf_netconf (session\u003d0x61300000ffc0, modules\u003d0x618000019480, user_clb\u003d0x0, user_data\u003d0x0, has_get_schema\u003d21) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/session_client.c:1099\n#19 nc_ctx_check_and_fill (session\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/session_client.c:1174\n#20 0x00007f38b321957a in nc_connect_inout (fdin\u003d5, fdout\u003d4, ctx\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/github/CESNET/libnetconf2/src/session_client.c:1289\n#21 0x00007f38b3935202 in libnetconf::client::Session::connectFd (source\u003d\u003coptimized out\u003e, sink\u003d\u003coptimized out\u003e, ctx\u003d...) at /home/jkt/work/cesnet/gerrit/CzechLight/libnetconf2-cpp/src/netconf-client.cpp:244\n#22 0x00000000005142c4 in DOCTEST_ANON_FUNC_2()::$_0::operator()() const (this\u003d\u003coptimized out\u003e) at /home/jkt/work/cesnet/gerrit/CzechLight/libnetconf2-cpp/tests/client.cpp:161\n#23 std::__invoke_impl\u003cvoid, DOCTEST_ANON_FUNC_2()::$_0\u003e(std::__invoke_other, DOCTEST_ANON_FUNC_2()::$_0\u0026\u0026) (__f\u003d...) at /nix/store/2dv93bbc06c7zg866qid73j3r36zz3jx-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:60\n#24 0x0000000000586330 in execute_native_thread_routine ()\n#25 0x00007f38b3506d40 in start_thread (arg\u003d0x7f38b09ff640) at pthread_create.c:481\n#26 0x00007f38b33f803f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95\n \nThread 1 (Thread 0x7f38b2092380 (LWP 3724361) \"test_client\"):\n#0  0x00007f38b3512cf5 in __futex_abstimed_wait_common64 (futex_word\u003dfutex_word@entry\u003d0x7f38b09ff910, expected\u003d3724362, clockid\u003dclockid@entry\u003d0, abstime\u003dabstime@entry\u003d0x0, private\u003dprivate@entry\u003d128, cancel\u003dcancel@entry\u003dtrue) at ../sysdeps/nptl/futex-internal.c:74\n#1  0x00007f38b3512d4b in __GI___futex_abstimed_wait_cancelable64 (futex_word\u003dfutex_word@entry\u003d0x7f38b09ff910, expected\u003d\u003coptimized out\u003e, clockid\u003dclockid@entry\u003d0, abstime\u003dabstime@entry\u003d0x0, private\u003dprivate@entry\u003d128) at ../sysdeps/nptl/futex-internal.c:123\n#2  0x00007f38b3508183 in __pthread_clockjoin_ex (threadid\u003d139881458169408, thread_return\u003d0x0, clockid\u003d0, abstime\u003d0x0, block\u003d\u003coptimized out\u003e) at pthread_join_common.c:102\n#3  0x0000000000586543 in std::thread::join() ()\n#4  0x0000000000515f46 in std::jthread::join (this\u003d0x7ffeb4b00310) at /nix/store/2dv93bbc06c7zg866qid73j3r36zz3jx-gcc-10.3.0/include/c++/10.3.0/thread:492\n#5  std::jthread::~jthread (this\u003d0x7ffeb4b00310) at /nix/store/2dv93bbc06c7zg866qid73j3r36zz3jx-gcc-10.3.0/include/c++/10.3.0/thread:462\n#6  0x0000000000511bed in DOCTEST_ANON_FUNC_2 () at /home/jkt/work/cesnet/gerrit/CzechLight/libnetconf2-cpp/tests/client.cpp:179\n#7  0x0000000000539ff8 in doctest::Context::run (this\u003d\u003coptimized out\u003e) at /home/jkt/work/prog/_build/czechlight-clang-asan-ubsan-ly2/target/include/doctest/doctest.h:6510\n#8  0x000000000053f2d7 in main (argc\u003d\u003coptimized out\u003e, argv\u003d\u003coptimized out\u003e) at /home/jkt/work/prog/_build/czechlight-clang-asan-ubsan-ly2/target/include/doctest/doctest.h:6595",
      "revId": "06f87f6a7b3d16e7da8340a440ff8f75badc3d05",
      "serverId": "e32f8df8-3db0-4f76-a6c6-fe9d6e69dd68"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "33ea5f4b_a47f3629",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000056
      },
      "writtenOn": "2022-03-31T10:51:28Z",
      "side": 1,
      "message": "It seems that when my function asserts, it no longer sends anything and then the client thread hangs...",
      "parentUuid": "e4a084ed_1c14eb0e",
      "revId": "06f87f6a7b3d16e7da8340a440ff8f75badc3d05",
      "serverId": "e32f8df8-3db0-4f76-a6c6-fe9d6e69dd68"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f7f20984_02cf78a3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2022-03-31T14:30:22Z",
      "side": 1,
      "message": "This means that either the exceptions from C++ code are not translated into proper C error codes, or that there\u0027s a bug in libnetconf2 or libyang that it keeps going forward even in face of invalid data. Either are wrong. Can you please debug this, fix the C++ side, and if it\u0027s broken in the C code, work with upstream to get it fixed?",
      "parentUuid": "33ea5f4b_a47f3629",
      "revId": "06f87f6a7b3d16e7da8340a440ff8f75badc3d05",
      "serverId": "e32f8df8-3db0-4f76-a6c6-fe9d6e69dd68"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5fcc21fb_3d8757f7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000056
      },
      "writtenOn": "2022-03-31T14:50:05Z",
      "side": 1,
      "message": "No, my server accepts a response, checks it inside of skipNetconfChunk and if it it\u0027s not the expected one, it throws (through the REQUIRE macro). Then it goes all the way to the end of the test case, where .join() is called on the client thread. However, at this point, the client thread is now awaiting the a response from the server indefinitely. It hangs on read() (or some other blocking call). That\u0027s why this thread is never joined",
      "parentUuid": "f7f20984_02cf78a3",
      "revId": "06f87f6a7b3d16e7da8340a440ff8f75badc3d05",
      "serverId": "e32f8df8-3db0-4f76-a6c6-fe9d6e69dd68"
    }
  ]
}